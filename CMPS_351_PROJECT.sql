DROP TABLE TRANSACTION_LOG;
DROP TABLE LOGIN;
DROP TABLE RESERVATION;
DROP TABLE AGENT;
DROP TABLE SITE;
DROP TABLE TRIP;
DROP TABLE GUIDE_LANGUAGES;
DROP TABLE GUIDE;
DROP TABLE CUSTOMER_PACKAGES;
DROP TABLE PACKAGE;
DROP TABLE CUSTOMER;

DROP TRIGGER CUSTOMER_TRIGGER51;
DROP TRIGGER RESERVATION_TRIGGER51;

DROP SEQUENCE RNO_SQ;
DROP SEQUENCE TID_SQ;

DROP VIEW RESERVATIONS;
DROP VIEW TRIPS_REPORT;

CREATE TABLE CUSTOMER(
CID NUMBER(20)NOT NULL,
CNAME VARCHAR2(20) NOT NULL,
HOTEL VARCHAR2(20),
PHONENO NUMBER(10) NOT NULL,
CONSTRAINT CID_PK PRIMARY KEY (CID),
CONSTRAINT CNAME_UQ UNIQUE (CNAME),
CONSTRAINT PHONENO_UQ UNIQUE (PHONENO)
);


CREATE TABLE PACKAGE(
PNUM NUMBER(10),
PNAME VARCHAR2(20) NOT NULL,
DESCRIPTION VARCHAR2(70),
CONSTRAINT PNUM_PK PRIMARY KEY (PNUM),
CONSTRAINT PNAME_UQ UNIQUE (PNAME));
    
CREATE TABLE CUSTOMER_PACKAGES( --SHOWS THE PACKAGES ASSOCIATED WITH EVERY CUSTOMER
CID NUMBER(20),
PNUM NUMBER(10),
CONSTRAINT CID_FK FOREIGN KEY (CID)
REFERENCES CUSTOMER(CID) ON DELETE CASCADE,
CONSTRAINT PNUM_FK FOREIGN KEY (PNUM)
REFERENCES PACKAGE(PNUM) ON DELETE CASCADE);



CREATE TABLE GUIDE(
GID NUMBER(10),
GNAME VARCHAR(20) NOT NULL,
CONSTRAINT GID_PK PRIMARY KEY (GID),
CONSTRAINT GNAME_UQ UNIQUE (GNAME) 
);


CREATE TABLE GUIDE_LANGUAGES(
GID NUMBER(10),
GLANG VARCHAR(20),
CONSTRAINT GID_FK9 FOREIGN KEY (GID) REFERENCES GUIDE (GID) ON DELETE CASCADE,
CONSTRAINT GLANG_PK PRIMARY KEY (GID, GLANG),  
CONSTRAINT GLANG_CK CHECK (GLANG IN ('ARABIC','ENGLISH','FRENCH','URDU'))
);



CREATE TABLE TRIP(
TID NUMBER(10),
PNUM NUMBER(10),
DESTINATION VARCHAR(20) NOT NULL,
LOCATION VARCHAR(20) NOT NULL,
TDATE DATE NOT NULL,
TIME VARCHAR(20) NOT NULL,
DURATION VARCHAR2(20),
PRICE NUMBER(10),
GID NUMBER(10) NOT NULL,
CONSTRAINT GID_FK48 FOREIGN KEY (GID) REFERENCES GUIDE(GID) ON DELETE CASCADE,
CONSTRAINT TID_PK PRIMARY KEY (TID),
CONSTRAINT PNUM_FK1 FOREIGN KEY (PNUM) REFERENCES PACKAGE (PNUM) ON DELETE CASCADE,
CONSTRAINT TRIP_DATE_UQ UNIQUE (GID, TDATE) --to make sure each guide guides one trip per day.
);



CREATE TABLE SITE (--SITE TABLE WILL SHOW  TRIP ID&SITE THE TRIP IS SUPPOSED TO PASS AND NEAREST LMARK
TID NUMBER(10),
SITE_NAME VARCHAR(20) NOT NULL,
NEAREST_LANDMARK VARCHAR(20),
CONSTRAINT TID_FK2 FOREIGN KEY (TID) 
REFERENCES TRIP (TID) ON DELETE CASCADE,
CONSTRAINT SITENAME_CK CHECK (SITE_NAME IN  ('Pearl', 'Simaisma', 'Qatar Museum', 'Banana Island')));




CREATE TABLE AGENT(
AID NUMBER(10),
ANAME VARCHAR2(20) NOT NULL,
CONSTRAINT AID_PK PRIMARY KEY (AID),
CONSTRAINT ANAME_UQ1 UNIQUE (ANAME)
);


CREATE TABLE RESERVATION(
AID NUMBER(10) NOT NULL,
RNO NUMBER(10),
RDATE DATE NOT NULL,
TID NUMBER(10),
PNUM NUMBER(10) NOT NULL,
CID NUMBER(7) NOT NULL ,
STATUS VARCHAR(20) NOT NULL,
CONSTRAINT AID_FK4 FOREIGN KEY (AID) REFERENCES AGENT(AID) ON DELETE CASCADE,
CONSTRAINT RNO_PK PRIMARY KEY (RNO),
CONSTRAINT TID_FK3 FOREIGN KEY (TID) REFERENCES TRIP(TID) ON DELETE CASCADE,
CONSTRAINT STATUS_CK CHECK (STATUS='CONFIRMED' or STATUS='CANCELLED'),
CONSTRAINT CID_FK6 FOREIGN KEY (CID) REFERENCES CUSTOMER(CID) ON DELETE CASCADE,
CONSTRAINT PNUM_FK12 FOREIGN KEY (PNUM) REFERENCES PACKAGE(PNUM) ON DELETE CASCADE ---
);



CREATE TABLE LOGIN (
USERNAME VARCHAR2(30) NOT NULL,
PASSWORD VARCHAR(30) NOT NULL ,
AID NUMBER(10) NOT NULL, 
CONSTRAINT USERNAME_PK PRIMARY KEY (USERNAME),
CONSTRAINT AID_FK1 FOREIGN KEY (AID) REFERENCES AGENT(AID) ON DELETE CASCADE,
CONSTRAINT AID_UQ UNIQUE (AID));--

CREATE TABLE TRANSACTION_LOG(
TRANS_DATE_TIME TIMESTAMP NOT NULL, 
USERNAME VARCHAR(30) NOT NULL,
AID NUMBER(10),
CONSTRAINT USERNAME_FK FOREIGN KEY (USERNAME) REFERENCES LOGIN (USERNAME) ON DELETE CASCADE,--
CONSTRAINT AID_FK90 FOREIGN KEY (AID) REFERENCES AGENT(AID) ON DELETE CASCADE--
);


	
--CREATING THE VIEW--

CREATE VIEW TRIPS_REPORT 
AS
SELECT * FROM TRIP;


CREATE VIEW RESERVATIONS AS
SELECT * FROM RESERVATION;

--SEQUENCES--

CREATE SEQUENCE RNO_SQ
    INCREMENT BY 3
    START WITH 3000
    MAXVALUE 60000
    MINVALUE 3000;
    
CREATE SEQUENCE TID_SQ
    INCREMENT BY 6
    START WITH 8000
    MAXVALUE 80000
    MINVALUE 8000;


--TRIGGERS

--PLEASE RUN TRIGGERS SEPERATELY

CREATE OR REPLACE TRIGGER CUSTOMER_TRIGGER51
BEFORE INSERT OR UPDATE OR DELETE ON CUSTOMER
FOR EACH ROW

DECLARE
    V_USER VARCHAR2(100);
    V_AID NUMBER(20);
BEGIN

    SELECT USER INTO V_USER FROM DUAL;


    SELECT AID INTO V_AID FROM LOGIN WHERE USERNAME = V_USER;


    INSERT INTO TRANSACTION_LOG (USERNAME,TRANS_DATE_TIME, AID) 
    VALUES (V_USER,SYSTIMESTAMP, V_AID);
END;




CREATE OR REPLACE TRIGGER RESERVATION_TRIGGER51
BEFORE INSERT OR UPDATE OR DELETE ON RESERVATION
FOR EACH ROW
DECLARE
    V_USER VARCHAR2(100);
    V_AID NUMBER;
BEGIN
  SELECT USER INTO V_USER FROM DUAL;


    SELECT AID INTO V_AID FROM LOGIN WHERE USERNAME = V_USER;


    INSERT INTO TRANSACTION_LOG (USERNAME,TRANS_DATE_TIME, AID) 
    VALUES (V_USER,SYSTIMESTAMP, V_AID);
END;

    
--DML--

--ADDING CUSTOMERS--


INSERT INTO AGENT (AID, ANAME) 
VALUES (2000677, 'Hamed Matar');

INSERT INTO AGENT (AID, ANAME) 
VALUES (2000678, 'Abdullah Omar');

--ADDING AGENT LOGIN INFO(LOGIN TABLE)
INSERT INTO LOGIN  
VALUES('HA2203150' , 'HA2203150', 2000677);

INSERT INTO LOGIN
VALUES('AO2010325' , 'AO2010325', 2000678);


INSERT INTO CUSTOMER (CID, CNAME, HOTEL, PHONENO)
VALUES (2000889, 'Ali Alkuwari', 'Palm Hotel', 1234567890);

INSERT INTO CUSTOMER (CID, CNAME, HOTEL, PHONENO)
VALUES (2000098, 'Fatima Ali', 'Rose Hotel', 2345678901);

INSERT INTO CUSTOMER (CID, CNAME, HOTEL, PHONENO)
VALUES (2000132, 'Mohammed Jamal', 'Jasmine Hotel', 3456789012);

INSERT INTO CUSTOMER (CID, CNAME, HOTEL, PHONENO)
VALUES (2000666, 'Layla Mohammed', 'Hilton Hotel', 4567890123);

INSERT INTO CUSTOMER 
VALUES(2000776 , 'Jassem Mohammed' , 'Hilton hotel' , 22344567);


--ADDING PACKAGES
INSERT INTO PACKAGE (PNUM, PNAME, DESCRIPTION) 
VALUES (1, 'Family Vacation', 'Fun activities for everyone');

INSERT INTO PACKAGE (PNUM, PNAME, DESCRIPTION) 
VALUES (2, 'Adventure', 'Exciting outdoor experiences');

INSERT INTO PACKAGE (PNUM, PNAME, DESCRIPTION) 
VALUES (3, 'Relaxation', 'Tranquil retreat to unwind');

INSERT INTO PACKAGE (PNUM, PNAME, DESCRIPTION) 
VALUES (4, 'City Tour', 'Guided exploration of the city');


--adding guides 
INSERT INTO GUIDE (GID, GNAME) 
VALUES (2000887, 'Ahmed Mohammed');

INSERT INTO GUIDE (GID, GNAME) 
VALUES (2000556, 'Maria James');

INSERT INTO GUIDE (GID, GNAME) 
VALUES (2000145, 'Jessica Miller');

INSERT INTO GUIDE (GID, GNAME) 
VALUES (2000785, 'Ali Yasser');

--adding guide langs
INSERT INTO GUIDE_LANGUAGES (GID, GLANG) 
VALUES (2000887, 'ARABIC');

INSERT INTO GUIDE_LANGUAGES (GID, GLANG) 
VALUES (2000785, 'ENGLISH');

INSERT INTO GUIDE_LANGUAGES (GID, GLANG) 
VALUES (2000887, 'FRENCH');

INSERT INTO GUIDE_LANGUAGES (GID, GLANG) 
VALUES (2000556, 'URDU');

--adding AGENT


--ADDING TRIPS AND SITES
INSERT INTO TRIP (TID, PNUM, DESTINATION, LOCATION, TDATE, TIME, DURATION, PRICE, GID) 
VALUES (TID_SQ.NEXTVAL, 2, 'Katara Village', 'Doha', TO_DATE('05-MAY-24', 'DD-MON-YY'), '2:00 PM', '5 Hours', 1650, 2000887);

INSERT INTO SITE (TID, SITE_NAME, NEAREST_LANDMARK) 
VALUES (TID_SQ.CURRVAL, 'Pearl', 'Marina Mall');

INSERT INTO RESERVATION (AID, RNO, RDATE, TID, PNUM, CID, STATUS) 
VALUES (2000677, RNO_SQ.NEXTVAL, TO_DATE('02-MAY-24', 'DD-MON-YY'), TID_SQ.CURRVAL, 2, 2000132, 'CANCELLED');

INSERT INTO CUSTOMER_PACKAGES
VALUES(2000132,1);



INSERT INTO TRIP (TID, PNUM, DESTINATION, LOCATION, TDATE, TIME, DURATION, PRICE, GID) 
VALUES (TID_SQ.NEXTVAL, 3, 'Aspire Park', 'Doha', TO_DATE('06-MAY-24', 'DD-MON-YY'), '1:00 PM', '3.5 Hours', 800, 2000145);

INSERT INTO SITE (TID, SITE_NAME, NEAREST_LANDMARK) 
VALUES (TID_SQ.CURRVAL, 'Simaisma', 'Simaisma Beach');

INSERT INTO RESERVATION (AID, RNO, RDATE, TID, PNUM, CID, STATUS) 
VALUES (2000677, RNO_SQ.NEXTVAL, TO_DATE('25-APR-24', 'DD-MON-YY'), TID_SQ.CURRVAL, 1, 2000666, 'CONFIRMED');

INSERT INTO CUSTOMER_PACKAGES (CID, PNUM) 
VALUES (2000666, 4);



INSERT INTO TRIP (TID, PNUM, DESTINATION, LOCATION, TDATE, TIME, DURATION, PRICE, GID) 
VALUES (TID_SQ.NEXTVAL, 4, 'Souq Waqif', 'Doha', TO_DATE('07-MAY-24', 'DD-MON-YY'), '5:00 PM', '2.5 hours', 1200, 2000785);

INSERT INTO SITE (TID, SITE_NAME, NEAREST_LANDMARK) 
VALUES (TID_SQ.CURRVAL, 'Qatar Museum', 'WEST BAY');

INSERT INTO RESERVATION (AID, RNO, RDATE, TID, PNUM, CID, STATUS) 
VALUES (2000677, RNO_SQ.NEXTVAL, TO_DATE('07-APR-24', 'DD-MON-YY'), TID_SQ.CURRVAL, 3, 2000098, 'CONFIRMED');

INSERT INTO CUSTOMER_PACKAGES (CID, PNUM) 
VALUES (2000098, 2);




INSERT INTO TRIP (TID, PNUM, DESTINATION, LOCATION, TDATE, TIME, DURATION, PRICE, GID) 
VALUES (TID_SQ.NEXTVAL, 1, 'Al Zubarah Fort', 'Al Zubarah', TO_DATE('08-MAY-24', 'DD-MON-YY'), '8:00 AM', '1 Day', 1500, 2000556);

INSERT INTO SITE (TID, SITE_NAME, NEAREST_LANDMARK) 
VALUES (TID_SQ.CURRVAL, 'Banana Island', 'Doha Corniche');

INSERT INTO RESERVATION (AID, RNO, RDATE, TID, PNUM, CID, STATUS) 
VALUES (2000677, RNO_SQ.NEXTVAL, TO_DATE('01-MAY-24', 'DD-MON-YY'), TID_SQ.CURRVAL, 4, 2000889, 'CONFIRMED');

INSERT INTO CUSTOMER_PACKAGES
VALUES(2000889,2);



